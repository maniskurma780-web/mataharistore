/**
 * File: script.js
 * Berisi fungsi-fungsi utilitas global yang digunakan di seluruh aplikasi e-commerce Qarin.Scarf
 */

// --- Fungsi Global untuk Local Storage ---

/**
 * Memuat daftar produk dari Local Storage.
 * Jika kosong, mengembalikan array kosong.
 * @returns {Array<Object>} Daftar produk.
 */
function loadProducts() {
    try {
        const products = JSON.parse(localStorage.getItem('products'));
        return Array.isArray(products) ? products : [];
    } catch (e) {
        console.error("Error loading products from Local Storage:", e);
        return [];
    }
}
window.loadProducts = loadProducts; // Daftarkan ke window agar bisa diakses

/**
 * Memuat daftar pesanan dari Local Storage.
 * Jika kosong, mengembalikan array dengan data dummy.
 * @returns {Array<Object>} Daftar pesanan.
 */
function loadOrders() {
    try {
        const orders = JSON.parse(localStorage.getItem('orders'));
        // Mengembalikan dummy data jika order kosong untuk tampilan awal
        if (!orders || orders.length === 0) {
            return [
                { customer: "Fatima A.", date: "2025-05-01", total: 100000, status: "Lunas", items: [{ nama: "Bella Square", qty: 2 }] },
                { customer: "Aisyah B.", date: "2025-05-02", total: 150000, status: "Menunggu Bayar", items: [{ nama: "Aura Pashmina", qty: 1 }] }
            ];
        }
        return orders;
    } catch (e) {
        console.error("Error loading orders from Local Storage:", e);
        return [];
    }
}
window.loadOrders = loadOrders;

/**
 * Memuat keranjang belanja dari Local Storage.
 * @returns {Array<Object>} Daftar item di keranjang.
 */
function loadCart() {
    try {
        const cart = JSON.parse(localStorage.getItem('cart'));
        return Array.isArray(cart) ? cart : [];
    } catch (e) {
        console.error("Error loading cart from Local Storage:", e);
        return [];
    }
}
window.loadCart = loadCart;

/**
 * Menyimpan data keranjang belanja ke Local Storage.
 * @param {Array<Object>} cart - Data keranjang yang akan disimpan.
 */
function saveCart(cart) {
    localStorage.setItem('cart', JSON.stringify(cart));
}
window.saveCart = saveCart;

// --- Fungsi Global Format ---

/**
 * Memformat angka menjadi format mata uang Rupiah.
 * @param {number} number - Angka yang akan diformat.
 * @returns {string} String dalam format Rupiah.
 */
function rupiah(number) {
    return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0
    }).format(number);
}
window.rupiah = rupiah;

/**
 * Memperbarui angka di ikon keranjang belanja (badge).
 */
function updateCartBadge() {
    const cart = loadCart();
    const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
    const badge = document.getElementById('cart-badge');
    if (badge) {
        badge.innerText = totalItems;
    }
}
window.updateCartBadge = updateCartBadge;

// --- Fungsi Checkout Sederhana (Dipanggil dari keranjang.html) ---
function checkout() {
    const cart = loadCart();
    const totalAmount = cart.reduce((sum, item) => sum + (item.harga * item.qty), 0);

    if (cart.length === 0) {
        // Mengganti alert dengan Swal
        Swal.fire('Keranjang Kosong!', 'Tambahkan produk ke keranjang untuk melanjutkan.', 'warning');
        return;
    }

    // Mengganti prompt() dengan Swal.fire input untuk mengambil nama pelanggan
    Swal.fire({
        title: 'Konfirmasi Pesanan',
        html: 'Total yang harus dibayar: <b>' + rupiah(totalAmount) + '</b><br><br>Masukkan Nama Lengkap Anda untuk label pengiriman:',
        input: 'text',
        inputPlaceholder: 'Nama Lengkap Anda...',
        showCancelButton: true,
        confirmButtonText: 'Proses Pesanan',
        cancelButtonText: 'Batal',
        preConfirm: (customerName) => {
            if (!customerName || customerName.trim() === '') {
                Swal.showValidationMessage('Nama lengkap harus diisi!');
                return false;
            }
            return customerName;
        }
    }).then((result) => {
        if (result.isConfirmed) {
            const customerName = result.value;
            
            // Buat objek order baru
            const newOrder = {
                customer: customerName,
                date: new Date().toLocaleDateString('id-ID'),
                total: totalAmount,
                status: "Menunggu Bayar", // Status awal
                items: cart.map(item => ({ nama: item.nama, qty: item.qty }))
            };

            // Simpan order ke Local Storage
            const orders = loadOrders().filter(o => o.customer !== "Fatima A." && o.customer !== "Aisyah B."); // Hapus data dummy jika ada
            orders.push(newOrder);
            localStorage.setItem('orders', JSON.stringify(orders));

            // Kosongkan keranjang
            saveCart([]);
            updateCartBadge();

            // Notifikasi berhasil
            Swal.fire('Pesanan Berhasil!', `Pesanan atas nama ${customerName} (Total: ${rupiah(totalAmount)}) telah dikirim ke Dashboard Admin.`, 'success').then(() => {
                window.location.href = 'index.html'; // Kembali ke halaman utama
            });
        } else {
            console.log('Checkout dibatalkan.');
        }
    });
}
window.checkout = checkout;
